# TCP 연결관리

---

**1:1 소켓 연결**
 연결 설정 과정(handshaking) 필요
 서버 연결 소켓 : 서버 IP 주소와 서버 Port 번호 공유 가능
 멀티캐스팅(multicasting) 지원 불가

+ 소켓주소 = IP 주소 + PORT 번호

![image](https://user-images.githubusercontent.com/68331041/136798922-ec3f6a63-b137-4ecf-876b-6274b5e49c71.png)

소켓연결을 이용하여 전이중 통신이 가능하다.

![image](https://user-images.githubusercontent.com/68331041/136805267-97db8e85-f9ae-4ebd-b017-4f14d18c0d90.png)

TCP는 데이터 전송을 바이트 스트림 형태로 전송한다.

![image](https://user-images.githubusercontent.com/68331041/136805784-63874611-ebf8-421a-b09d-22c8d3d3a29c.png)

+ 데이터를 여러개의 세그먼트로 생성하여 전송
+ 위으 서버 응용 프로세스는 필요한만큼의 세그먼트를 수신버퍼에서 수신하여 활용한다.





![image](https://user-images.githubusercontent.com/68331041/136806152-a181b051-d8c4-45e8-85d5-1172e32e151b.png)

+ 1. **클라이언트: SYN세그먼트(싱크세그먼트)를 전송**

  > <img src="https://user-images.githubusercontent.com/68331041/136807025-16486040-d8e2-4f31-836d-b9ae89a37ea9.png" alt="image" style="zoom: 67%;" />
  >
  > + 순서번호 SN필드 순서번호 설정
  > + SYN 세그먼트는 데이터가 없지만 있는것처럼 가상 1바이트 데이터 보유

+ 2. **서버가 자원이 충분하면 연결수락 SYN + ACK 세그먼트 응답**

> <img src="https://user-images.githubusercontent.com/68331041/136807753-28e1d99a-a85a-41a4-a1e3-a857d350aef0.png" alt="image" style="zoom:67%;" />

+ 3. **클라이언트 ACK 세그먼트 응답**

  > <img src="https://user-images.githubusercontent.com/68331041/136807857-1f0f07a1-50d5-470d-bf70-6fe8bbd20bdc.png" alt="image" style="zoom:67%;" />

+ 4. 전이중통신 가능

  > 위 3단계 **3HAND SHAKE** **완료후 데이터 통신 가능**





![image](https://user-images.githubusercontent.com/68331041/136808582-693ef5b3-e337-4f7d-86ca-4acc1a849a49.png)

+ 연결 해제의 경우 4 핸드 셰이킹
+ 양쪽 연결 해제



# TCP 세그먼트

---

![image](https://user-images.githubusercontent.com/68331041/136978009-68c49d92-a320-4794-a74b-337a46648d01.png)

+ Data가 프로토콜을 통과하면서 전송을 위한 정보를 덧씌워진다.
+ 데이터 단위를 소분하여 전송한다.
+ 데이터 링크의 MTU: 1500 최대 전송 바이트 수



### 세그멘테이션

+ tcp에서 데이터를 소분하여 세그먼트들로 만든다.



### TCP 세그먼트

헤더(control information) 필드 + 데이터(payload) 필드

헤더 : mandatory, 데이터 : optional

![image](https://user-images.githubusercontent.com/68331041/136978858-bd8e95e0-8e09-4ce6-890f-5d079d0754ff.png)

+ 응용 계층의 Data를 tcp세그먼트로 만들고 이를 IP계층 Data에 담는다.
+ IP packet은 네트워크 링크로 보내진다. MTU(최대 전송 유닛) < 1500byte

###  MSS(Maximum Segment Size)

**TCP는** 응용어플리케이션 **데이터를 분할하여 세그멘테이션한다.**

이때 분할된 Data는 각 세그먼트의 Data 필드에 담기는데 이 세그먼트들의 Data 필드의 최대 크기

를 MSS라고 한다. **TCP segment Data필드에 최대 크기**

+ TCP 헤더 크기 + IP 헤더 크기+ MSS ≤ **MTU**



![image](https://user-images.githubusercontent.com/68331041/136979940-d4b3247d-e98b-432d-8dc7-a76ec38f5700.png)

**TCP 포트 번호(Port Number)**

> HTTP SMTP 등 응용 프로토콜 식별
>
> 클라이언트 포트 번호 : 연결 설정 시에 임의의 포트 번호 할당(Ephemeral Port)
> 서버 포트 번호 : 연결 설정 전에 미리 할당(Well-known Port)
> 출발지(source) 포트 번호 : 세그먼트 송신자의 포트 번호, 16 비트
> 목적지(destination) 포트 번호 : 세그먼트 수신자의 포트 번호, 16 비트

**순서 번호(Sequence Number)**

> Seq
>
> **시작 순서 번호(ISN)**는 연결 설정할때 정해진다.
>
> **ISN + 송신된바이트수**
> ISN : 3,000, 송신된바이트수 : 1,000  순서 번호 = 4,000
>
> 세그먼트 번호가 아님

**확인 번호(Acknowledgement Number)**

> ACK
>
> 순서대로 수신된 세그먼트의 **마지막 순서번호의 다음 번호** : **기대 순서번호**

**헤더 길이(Header Length)**

> 헤더 필드 전체 길이

**수신 윈도우(Receive Window) 크기**

> 수신 TCP가 수신 가능한 데이터 크기(버퍼 여유 공간)

**제어 플래그(Control Flags)**

> URG : Urgent
> ACK : Acknowledgement
> PSH : push
> RST : Reset
> SYN : Synchronization
> FIN : Finish

**긴급 데이터 포인터(Urgent Data Pointer)**

> 긴급 데이터 위치



## TCP 재전송 타이머 설정

+ TCP RTT를 알아야한다

>세그먼트 송신 후 ACK 수신까지 걸리는 시간
>네트워크 상태에 따라 가변적인 시간: 매번 다르다

**재전송 타이머 설정(TimeoutInterval)** = 추정RTT(EstimatedRTT) + 4*분산RTT 안전여분(4*DevRTT)

> **재전송 타이머가 지나면 누락데이터로 판단 재송신한다.**







